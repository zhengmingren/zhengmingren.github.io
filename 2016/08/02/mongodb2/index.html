<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <meta name="description" content="1. 创建文档插入是向MongDB添加数据的基本方法。一般使用insert方法插入一个文档。
1&amp;gt; db.foo.insert(&amp;#123;&quot;bar&quot;:&quot;baz&quot;&amp;#125;)
这个操作会给文档增加一个“_id”键（要是原来的话），然后将其保存在MongDB中。
当执行插入的时候，驱动程序会将" />
  

  
  
  
  
  
  
  <title>第二章 MongDB创建、更新及删除文档 | 行动的力量</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1. 创建文档插入是向MongDB添加数据的基本方法。一般使用insert方法插入一个文档。
1&amp;gt; db.foo.insert(&amp;#123;&quot;bar&quot;:&quot;baz&quot;&amp;#125;)
这个操作会给文档增加一个“_id”键（要是原来的话），然后将其保存在MongDB中。
当执行插入的时候，驱动程序会将数据转换成BSON格式，然后存入数据库。数据库会解析BSON，检验是否包含“_id”键且文档不超过4">
<meta property="og:type" content="article">
<meta property="og:title" content="第二章 MongDB创建、更新及删除文档">
<meta property="og:url" content="http://yoursite.com/2016/08/02/mongodb2/index.html">
<meta property="og:site_name" content="行动的力量">
<meta property="og:description" content="1. 创建文档插入是向MongDB添加数据的基本方法。一般使用insert方法插入一个文档。
1&amp;gt; db.foo.insert(&amp;#123;&quot;bar&quot;:&quot;baz&quot;&amp;#125;)
这个操作会给文档增加一个“_id”键（要是原来的话），然后将其保存在MongDB中。
当执行插入的时候，驱动程序会将数据转换成BSON格式，然后存入数据库。数据库会解析BSON，检验是否包含“_id”键且文档不超过4">
<meta property="og:updated_time" content="2016-09-02T09:42:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第二章 MongDB创建、更新及删除文档">
<meta name="twitter:description" content="1. 创建文档插入是向MongDB添加数据的基本方法。一般使用insert方法插入一个文档。
1&amp;gt; db.foo.insert(&amp;#123;&quot;bar&quot;:&quot;baz&quot;&amp;#125;)
这个操作会给文档增加一个“_id”键（要是原来的话），然后将其保存在MongDB中。
当执行插入的时候，驱动程序会将数据转换成BSON格式，然后存入数据库。数据库会解析BSON，检验是否包含“_id”键且文档不超过4">
  
  
    <link rel="icon" href="/css/images/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

  
  <!-- baidu webmaster push -->
  <script src='//push.zhanzhang.baidu.com/push.js'></script>
</head>
<body class="home blog custom-background custom-font-enabled single-author">
  <div id="page" class="hfeed site">
      <header id="masthead" class="site-header" role="banner">
    <hgroup>
      <h1 class="site-title">
        <a href="/" title="行动的力量" rel="home">行动的力量</a>
      </h1>
      
        <script type="text/javascript" src="http://api.hitokoto.us/rand?encode=js&charset=utf-8"></script>
        <h2 class="site-description"><script>hitokoto();</script></h2>
      
    </hgroup>

    <nav id="site-navigation" class="main-navigation" role="navigation">
            <button class="menu-toggle">菜单</button>
            <a class="assistive-text" href="/#content" title="跳至内容">跳至内容</a><!--TODO-->
            <div class="menu-main-container">
                <ul id="menu-main" class="nav-menu">
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/archives">技术</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/article">文章</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/movie">电影</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/music">音乐</a></li>
                
                </ul>
            </div>
    </nav>
</header>
      <div id="main" class="wrapper">
        <div id="primary" class="site-content"><div id="content" role="main"><article id="post-mongodb2" class="post-mongodb2 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title article-title">
      第二章 MongDB创建、更新及删除文档
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="http://yoursite.com/2016/08/02/mongodb2/" data-id="cj14rliyj000dkzzqtzkj1bo6" class="leave-reply bdsharebuttonbox" data-cmd="more">undefined</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <h3 id="1-创建文档"><a href="#1-创建文档" class="headerlink" title="1. 创建文档"></a>1. 创建文档</h3><p>插入是向MongDB添加数据的基本方法。一般使用insert方法插入一个文档。</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.foo.<span class="keyword">insert</span>(&#123;<span class="string">"bar"</span>:<span class="string">"baz"</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>这个操作会给文档增加一个“_id”键（要是原来的话），然后将其保存在MongDB中。</p>
<p>当执行插入的时候，驱动程序会将数据转换成BSON格式，然后存入数据库。数据库会解析BSON，检验是否包含“_id”键且文档不超过4MB，除此之外，不再做别的验证。这样做最明显的副作用是允许出入无效数据，但它能令数据库更加安全，远离注入式攻击。</p>
<p>如果要出入多个文档，使用批量插入会更快些，批量插入能传递一个由文档构成的数组给数据库。一次发送数十、数百个乃至数千个文档会明显提高插入的速度。一次批量插入只是单个的TCP请求，避免了许多零碎的请求所带来的开销。只有插入多个文档到一个集合的时候才有用，而不能用批量插入一次对多个集合执行操作。</p>
<h3 id="2-删除文档"><a href="#2-删除文档" class="headerlink" title="2. 删除文档"></a>2. 删除文档</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="tag">db</span><span class="class">.users</span><span class="class">.remove</span>(<span class="rules">&#123;&#125;</span>)</span><br></pre></td></tr></table></figure>
<p>这个命令会删除users集合中的所有文档，但不会删除集合本身和集合原有的索引，remove函数可以接受一个查询文档作为参数，给定参数后，只有符合条件的文档才会被删除。例如，假设要删除users集合中“status”为0的人：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.users.<span class="keyword">remove</span>(&#123;<span class="string">"status"</span>: <span class="number">0</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>删除数据是永久的，不能撤销，也不能恢复。</p>
<p>删除文档通常会很快，但是要清除整个集合，直接删除集合（然后重建索引）会更快。但是删除的时候不能有任何限制条件，而且索引也不见了。</p>
<h3 id="3-更新文档"><a href="#3-更新文档" class="headerlink" title="3. 更新文档"></a>3. 更新文档</h3><p>文档存入数据库后，就可以用update方法来修改它。update有两个参数，一个是查询文档，用来匹配找出要跟新的文档，另一个是修改器（modiffier）文档，描述对找到的文档做哪些更改。</p>
<h4 id="3-1-文档替换"><a href="#3-1-文档替换" class="headerlink" title="3.1 文档替换"></a>3.1 文档替换</h4><p>更新最简单的情形就是完全用一个新的文档替代匹配的文档，适用于模式结构发生了较大变化的时候。例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">_id</span>" : <span class="value">ObjectId(<span class="string">"57c7a7c0c19bb8028297a356"</span>)，</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"joe"</span>，</span><br><span class="line">  <span class="string">"friends"</span> : <span class="number">32</span></span>,</span><br><span class="line">  "<span class="attribute">enenmies</span>" : <span class="value"><span class="number">2</span></span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>想变成下面的样子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">_id</span>" : <span class="value">ObjectId(<span class="string">"57c7a7c0c19bb8028297a356"</span>)</span>,</span><br><span class="line">  "<span class="attribute">username</span>" : <span class="value"><span class="string">"joe"</span></span>,</span><br><span class="line">  "<span class="attribute">relationships</span>" : <span class="value">&#123;</span><br><span class="line">  					"<span class="attribute">friends</span>" : <span class="value"><span class="number">32</span></span>,</span><br><span class="line">  					"<span class="attribute">enemies</span>" : <span class="value"><span class="number">2</span></span><br><span class="line">				</span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>可以用update来替换文档：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; var joe = db.users.findOne(&#123;<span class="string">"name"</span> : <span class="string">"joe"</span>&#125;);</span><br><span class="line">&gt; joe.relationships = &#123;<span class="string">"friends"</span> : joe.friends, <span class="string">"enemies"</span> : joe.enemies&#125;;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"friends"</span> : <span class="number">32</span>,</span><br><span class="line">  <span class="string">"enemies"</span> : <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line">&gt; joe.username = joe.name;</span><br><span class="line"><span class="string">"joe"</span></span><br><span class="line">&gt; <span class="keyword">delete</span> joe.friends;</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">&gt; <span class="keyword">delete</span> joe.enemies;</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">&gt; <span class="keyword">delete</span> joe.name;</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">&gt; db.users.<span class="keyword">update</span>(&#123;<span class="string">"name"</span> : <span class="string">"joe"</span>&#125;, joe);</span><br></pre></td></tr></table></figure>
<p>常见的错误就是查询条件匹配了多个文档，然后更新的时候由于第二个参数的存在就产生重复的“_id”值。数据库会报错，不做任何修改。</p>
<p>例如，有好几个文档都有相同的“name”，但是我们没有意识到：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.users.find()</span><br><span class="line">&#123;<span class="string">"_id"</span> : ObjectId(<span class="string">"57c7a7c0c19bb8028297a356"</span>), <span class="string">"name"</span> : <span class="string">"joe"</span>, <span class="string">"age"</span> : 65&#125;</span><br><span class="line">&#123;<span class="string">"_id"</span> : ObjectId(<span class="string">"57c7a7c0c19bb8028297a356"</span>), <span class="string">"name"</span> : <span class="string">"joe"</span>, <span class="string">"age"</span> : 55&#125;</span><br><span class="line">&#123;<span class="string">"_id"</span> : ObjectId(<span class="string">"57c7a7c0c19bb8028297a356"</span>), <span class="string">"name"</span> : <span class="string">"joe"</span>, <span class="string">"age"</span> : 45&#125;</span><br></pre></td></tr></table></figure>
<p>现在如果第二个joe过生日，要增加“age”的值，可能会这么做：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; joe = <span class="keyword">db</span>.users.findOne(&#123;<span class="string">"name"</span> : <span class="string">"joe"</span>, <span class="string">"age"</span> : <span class="string">"55"</span>&#125;);</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_id"</span> : ObjectId(<span class="string">"57c7a7c0c19bb8028297a356"</span>),</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"joe"</span>,</span><br><span class="line">  <span class="string">"age"</span> : 20</span><br><span class="line">&#125;</span><br><span class="line">&gt; joe.age ++;</span><br><span class="line">&gt; <span class="keyword">db</span>.users.<span class="keyword">update</span>(&#123;<span class="string">"name"</span> : <span class="string">" joe"</span>&#125;, joe);</span><br><span class="line">E11001 duplicate key <span class="keyword">on</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>
<p>当调用update时，数据库会查找一个与{“name” : “joe”}匹配的文档。找到的第一个是65岁的joe。然后数据库试着用变量joe中的内容替换找到文档，但是会发现集合中以经有一个具有同样的“_id”的文档。所以跟新就会失败，因为“_id”值必须唯一。为了避免这种情况，最好确保跟新总是指定唯一文档。</p>
<h4 id="3-2-使用修改器"><a href="#3-2-使用修改器" class="headerlink" title="3.2 使用修改器"></a>3.2 使用修改器</h4><p>利用原子的更新修改器，可以只更新文档的一部分，这种更新极为高效。更新修改器是种特殊键，用来指定复杂的更新操作，比如调整、增加或删除键。例如访问URL的访问次数统计：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"_id"</span> : ObjectId(<span class="string">"57c7a7c0c19bb8028297a356"</span>),</span><br><span class="line">  <span class="string">"url"</span> : <span class="string">"www.baidu.com"</span>,</span><br><span class="line">  <span class="string">"pageviews"</span> : <span class="number">55</span></span><br><span class="line">&#125;</span><br><span class="line">&gt; db.analytics.<span class="keyword">update</span>(&#123;<span class="string">"url"</span> : <span class="string">"www.baidu.com"</span>&#125;, &#123;<span class="string">"$inc"</span> : &#123;<span class="string">"pageviews"</span> : <span class="number">1</span>&#125;&#125;)</span><br><span class="line">&gt; db.analytics.find()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_id"</span> : ObjectId(<span class="string">"57c7a7c0c19bb8028297a356"</span>),</span><br><span class="line">  <span class="string">"url"</span> : <span class="string">"www.baidu.com"</span>,</span><br><span class="line">  <span class="string">"pageviews"</span> : <span class="number">56</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>“$set”修改器入门</p>
<p>​</p>
</li>
</ul>

      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/2016/08/02/mongodb2/">
    <time datetime="2016-08-02T01:24:26.000Z" class="entry-date">
        2016-08-02
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/MongDB/">MongDB</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongDB/">MongDB</a></li></ul>

    </footer>
</article>


    
<nav class="nav-single">
    <h3 class="assistive-text">文章导航</h3>
    
        <span class="nav-previous"><a href="/2016/08/02/springmvc2/" rel="prev"><span class="meta-nav">←</span> 第二章 Spring MVC简介</a></span>
    
    
        <span class="nav-next"><a href="/2016/08/02/mongodb/" rel="next">第一章 MongDB简介 <span class="meta-nav">→</span></a></span>
    
</nav><!-- .nav-single -->







</div></div>
        <div id="secondary" class="widget-area" role="complementary">
  
    <aside id="search" class="widget widget_search"><form role="search" method="get" accept-charset="utf-8" id="searchform" class="searchform" action="//google.com/search">
    <div>
        <input type="text" value="" name="s" id="s" />
        <input type="submit" id="searchsubmit" value="搜索" />
    </div>
</form></aside>
  
    
  <aside class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-content">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/MongDB/">MongDB</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/springmvc/">springmvc</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">快乐的Linux命令行</a><span class="category-list-count">2</span></li></ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-content tagcloud">
      <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/MongDB/" style="font-size: 10px;">MongDB</a> <a href="/tags/springmvc/" style="font-size: 10px;">springmvc</a>
    </div>
  </aside>

  
</div>
      </div>
      <footer id="colophon" role="contentinfo">
    <p>&copy; 2017 A MAN
    All rights reserved.</p>
    <p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></p>
</footer>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

<script src="/js/jquery-2.0.3.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

<script src="/js/navigation.js"></script>

<div id="bg"></div>

  </div>
</body>
</html>